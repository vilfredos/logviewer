{% extends "base.html" %}

{% block title %}Visualización de Logs - LogViewer{% endblock %}

{% block extra_head %}
<style>
    .log-table {
        font-size: 0.9rem;
    }
    .log-table th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
    }
    .log-container {
        max-height: 70vh;
        overflow-y: auto;
    }
    .log-raw {
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 100px;
        overflow-y: auto;
    }
    .log-error {
        color: #dc3545;
    }
    .log-warning {
        color: #ffc107;
    }
    .log-info {
        color: #0dcaf0;
    }
    .copy-button {
        margin-right: 10px;
    }
    .checkbox-column {
        width: 40px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between mb-3">
    <form action="{{ url_for('clear_database_route') }}" method="POST">
        <button type="submit" class="btn btn-danger">Limpiar Base de Datos</button>
    </form>
    
    <button id="copySelectedBtn" class="btn btn-primary copy-button" disabled>Copiar selección</button>
</div>

<div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link {% if request.path == url_for('reports') %}active{% endif %}" href="{{ url_for('reports') }}">Reportes</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if request.path == url_for('alerts') %}active{% endif %}" href="{{ url_for('alerts') }}">Alertas</a>
        </li>
    </ul>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    {% if filename %}
                        <span>Archivo: <strong>{{ filename }}</strong></span>
                    {% else %}
                        <span>Logs en base de datos</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <div class="log-container">
                    {% if log_type == 'apache_access' %}
                        <table class="table table-striped table-hover log-table mb-0">
                            <thead>
                                <tr>
                                    <th class="checkbox-column">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>IP</th>
                                    <th>Fecha/Hora</th>
                                    <th>Método</th>
                                    <th>Ruta</th>
                                    <th>Estado</th>
                                    <th>Tamaño</th>
                                    <th>protocolo</th>
                                    <th>Referencia</th>
                                    <th>navegador</th>
                                    <th>bytes_enviados</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td class="checkbox-column">
                                        <input type="checkbox" class="form-check-input row-checkbox">
                                    </td>
                                    <td>{{ log.ip }}</td>
                                    <td>{{ log.fecha_hora }}</td>
                                    <td>{{ log.metodo }}</td>
                                    <td title="{{ log.ruta }}">{{ log.ruta|truncate(30) }}</td>
                                    <td>{{ log.codigo_estado }}</td>
                                    <td>{{ log.bytes_enviados }}</td>
                                    <td>{{ log.protocolo }}</td>
                                    <td>{{ log.referer }}</td>
                                    <td>{{ log.user_agent }}</td>
                                    <td>{{ log.bytes_enviados }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% elif log_type == 'apache_error' %}
                        <table class="table table-striped table-hover log-table mb-0">
                            <thead>
                                <tr>
                                    <th class="checkbox-column">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Fecha/Hora</th>
                                    <th>Nivel</th>
                                    <th>Cliente</th>
                                    <th>Mensaje</th>
                                    <th>Archivo</th>
                                    <th>Línea</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr class="{% if log.nivel_error == 'error' %}log-error{% elif log.nivel_error == 'warning' %}log-warning{% elif log.nivel_error == 'info' %}log-info{% endif %}">
                                    <td class="checkbox-column">
                                        <input type="checkbox" class="form-check-input row-checkbox">
                                    </td>
                                    <td>{{ log.fecha_hora }}</td>
                                    <td>{{ log.nivel_error }}</td>
                                    <td>{{ log.cliente }}</td>
                                    <td title="{{ log.mensaje }}">{{ log.mensaje|truncate(50) }}</td>
                                    <td>{{ log.archivo }}</td>
                                    <td>{{ log.linea }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% elif log_type == 'ftp_log' %}
                        <table class="table table-striped table-hover log-table mb-0">
                            <thead>
                                <tr>
                                    <th class="checkbox-column">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Fecha/Hora</th>
                                    <th>Usuario</th>
                                    <th>IP</th>
                                    <th>Acción</th>
                                    <th>Archivo</th>
                                    <th>Detalles</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td class="checkbox-column">
                                        <input type="checkbox" class="form-check-input row-checkbox">
                                    </td>
                                    <td>{{ log.fecha_hora }}</td>
                                    <td>{{ log.usuario }}</td>
                                    <td>{{ log.ip }}</td>
                                    <td>{{ log.accion }}</td>
                                    <td title="{{ log.archivo }}">{{ log.archivo|truncate(30) }}</td>
                                    <td title="{{ log.detalles }}">{{ log.detalles|truncate(50) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% elif log_type == 'ftp_transfer' %}
                        <table class="table table-striped table-hover log-table mb-0">
                            <thead>
                                <tr>
                                    <th class="checkbox-column">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Fecha/Hora</th>
                                    <th>Usuario</th>
                                    <th>IP</th>
                                    <th>Archivo</th>
                                    <th>Tamaño</th>
                                    <th>Dirección</th>
                                    <th>Duración</th>
                                    <th>servidor</th>
                                    <th>tipo_transferencia </th>
                                    <th>accion_especial </th>
                                    <th>servicio </th>
                                    <th>metodo_autenticacion </th>
                                    <th>usuario_id</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td class="checkbox-column">
                                        <input type="checkbox" class="form-check-input row-checkbox">
                                    </td>
                                    <td>{{ log.fecha_hora }}</td>
                                    <td>{{ log.usuario }}</td>
                                    <td>{{ log.ip_remota }}</td>
                                    <td title="{{ log.archivo }}">{{ log.archivo|truncate(30) }}</td>
                                    <td>{{ log.tamaño_archivo }}</td>
                                    <td>{{ 'Subida' if log.direccion == 'i' else 'Descarga' }}</td>
                                    <td>{{ log.duracion }}seg</td>
                                    <td>{{ log.servidor }}</td>
                                    <td>{{ log.tipo_transferencia }}</td>
                                    <td>{{ log.accion_especial }}</td>
                                    <td>{{ log.servicio  }}</td>
                                    <td>{{ log.metodo_autenticacion  }}</td>
                                    <td>{{ log.usuario_id }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="p-4 text-center">
                            <p>Seleccione un tipo de log para visualizar</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Buscador de Logs</h5>
  </div>
  <div class="card-body">
    <form action="{{ url_for('search_logs') }}" method="GET" id="searchForm">
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="searchTerm" class="form-label">Búsqueda básica:</label>
          <input type="text" class="form-control" id="searchTerm" name="searchTerm" placeholder="Buscar ocurrencia de texto...">
        </div>
        <div class="col-md-6">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" id="advancedSearch" name="advancedSearch">
            <label class="form-check-label" for="advancedSearch">
              Búsqueda avanzada
            </label>
          </div>
        </div>
      </div>
      
      <div id="advancedOptions" style="display: none;">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="startDate" class="form-label">Fecha inicio:</label>
            <input type="datetime-local" class="form-control" id="startDate" name="startDate">
          </div>
          <div class="col-md-6">
            <label for="endDate" class="form-label">Fecha fin:</label>
            <input type="datetime-local" class="form-control" id="endDate" name="endDate">
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label">Operadores lógicos:</label>
            <div class="d-flex">
              <div class="input-group me-2">
                <input type="text" class="form-control" name="term1" placeholder="Término 1">
              </div>
              <select class="form-select me-2" name="operator" style="width: auto;">
                <option value="AND">AND</option>
                <option value="OR">OR</option>
              </select>
              <div class="input-group">
                <input type="text" class="form-control" name="term2" placeholder="Término 2">
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="filterField" class="form-label">Filtrar por campo:</label>
            <select class="form-select" id="filterField" name="filterField">
              <option value="">Seleccionar campo...</option>
              {% if log_type == 'apache_access' %}
                <option value="ip">IP</option>
                <option value="metodo">Método</option>
                <option value="ruta">Ruta</option>
                <option value="codigo_estado">Estado</option>
                <option value="user_agent">Navegador</option>
              {% elif log_type == 'apache_error' %}
                <option value="nivel_error">Nivel</option>
                <option value="cliente">Cliente</option>
                <option value="mensaje">Mensaje</option>
              {% elif log_type == 'ftp_log' %}
                <option value="usuario">Usuario</option>
                <option value="ip">IP</option>
                <option value="accion">Acción</option>
                <option value="archivo">Archivo</option>
              {% elif log_type == 'ftp_transfer' %}
                <option value="usuario">Usuario</option>
                <option value="ip_remota">IP</option>
                <option value="archivo">Archivo</option>
                <option value="direccion">Dirección</option>
              {% endif %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="filterValue" class="form-label">Valor:</label>
            <input type="text" class="form-control" id="filterValue" name="filterValue" placeholder="Valor a buscar...">
          </div>
        </div>
      </div>
      
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Buscar</button>
        <button type="reset" class="btn btn-secondary ms-2">Limpiar</button>
      </div>
    </form>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const copySelectedBtn = document.getElementById('copySelectedBtn');

        // Función para actualizar el estado del botón de copia
        function updateCopyButtonState() {
            const anyChecked = Array.from(rowCheckboxes).some(checkbox => checkbox.checked);
            copySelectedBtn.disabled = !anyChecked;
        }

        // Evento para el checkbox "Seleccionar todo"
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                updateCopyButtonState();
            });
        }

        // Eventos para los checkboxes de cada fila
        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Verificar si todos los checkboxes están marcados
                const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = !allChecked && Array.from(rowCheckboxes).some(cb => cb.checked);
                }
                updateCopyButtonState();
            });
        });

        // Función para copiar las filas seleccionadas
        copySelectedBtn.addEventListener('click', function() {
            const selectedRows = [];
            
            rowCheckboxes.forEach((checkbox, index) => {
                if (checkbox.checked) {
                    const row = checkbox.closest('tr');
                    const rowData = [];
                    
                    // Obtener todos los datos de la fila (excluyendo la celda del checkbox)
                    row.querySelectorAll('td:not(.checkbox-column)').forEach(cell => {
                        rowData.push(cell.textContent.trim());
                    });
                    
                    selectedRows.push(rowData.join('\t'));
                }
            });
            
            if (selectedRows.length > 0) {
                // Copiar al portapapeles
                const textToCopy = selectedRows.join('\n');
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        alert('Filas seleccionadas copiadas al portapapeles');
                    })
                    .catch(err => {
                        console.error('Error al copiar: ', err);
                        alert('Error al copiar. Intente nuevamente.');
                    });
            }
        });

        // Inicializar el estado del botón
        updateCopyButtonState();
    });

        // Script para el buscador
    document.addEventListener('DOMContentLoaded', function() {
        const advancedSearchCheckbox = document.getElementById('advancedSearch');
        const advancedOptions = document.getElementById('advancedOptions');
        
        if (advancedSearchCheckbox && advancedOptions) {
            advancedSearchCheckbox.addEventListener('change', function() {
                advancedOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Inicializar estado basado en la URL (para cuando se vuelve de una búsqueda)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('advancedSearch') === 'on') {
                advancedSearchCheckbox.checked = true;
                advancedOptions.style.display = 'block';
            }
        }
    });

</script>

{% endblock %}