{% extends 'base.html' %}

{% block title %}Log Analysis Reports{% endblock %}

{% block content %}
<div class="container mt-4">
<button onclick="window.history.back()" class="btn btn-outline-secondary">‚Üê Volver</button>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4>Log Analysis Report</h4>
        </div>
        <div class="card-body">
            {% if active_table %}
                <div class="alert alert-info">
                    <strong>Active Data Source:</strong> {{ active_table }} ({{ record_count }} records)
                </div>
                
                {% if report_data.type == "apache_access" %}
                    <!-- Apache Access Log Report -->
                    <h3 class="mt-4 mb-3">Apache Access Log Analysis</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>General Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total Requests:</strong> {{ report_data.total_requests }}</p>
                                    <p><strong>Response Time:</strong> 
                                        Avg: {{ "%.3f"|format(report_data.response_time_stats.avg_time) }}s, 
                                        Min: {{ "%.3f"|format(report_data.response_time_stats.min_time) }}s, 
                                        Max: {{ "%.3f"|format(report_data.response_time_stats.max_time) }}s
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>HTTP Methods Distribution</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.http_methods_chart }}" class="img-fluid" alt="HTTP Methods Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Response Size Distribution</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.response_sizes_chart }}" class="img-fluid" alt="Response Size Chart">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Requests Over Time</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.requests_by_day_chart }}" class="img-fluid" alt="Requests By Day Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Top 10 Pages</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Page URL</th>
                                                    <th>Requests</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for page in report_data.popular_pages %}
                                                <tr>
                                                    <td>{{ page.ruta }}</td>
                                                    <td>{{ page.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>HTTP Status Codes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Status Code</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for code in report_data.status_codes %}
                                                <tr>
                                                    <td>{{ code.codigo_estado }}</td>
                                                    <td>{{ code.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Top 10 Referrers</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Referrer</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for ref in report_data.top_referrers %}
                                                <tr>
                                                    <td>{{ ref.referer }}</td>
                                                    <td>{{ ref.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Top 10 IPs</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>IP Address</th>
                                                    <th>Requests</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for ip in report_data.top_ips %}
                                                <tr>
                                                    <td>{{ ip.ip }}</td>
                                                    <td>{{ ip.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                {% elif report_data.type == "apache_error" %}
                    <!-- Apache Error Log Report -->
                    <h3 class="mt-4 mb-3">Apache Error Log Analysis</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>General Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total Errors:</strong> {{ report_data.total_errors }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Error Level Distribution</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.error_level_chart }}" class="img-fluid" alt="Error Level Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Errors Over Time</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.errors_by_day_chart }}" class="img-fluid" alt="Errors By Day Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Most Common Error Messages</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Error Message</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for error in report_data.common_errors %}
                                                <tr>
                                                    <td>{{ error.mensaje_short }}</td>
                                                    <td>{{ error.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Files with Most Errors</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>File</th>
                                                    <th>Error Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for file in report_data.error_files %}
                                                <tr>
                                                    <td>{{ file.archivo }}</td>
                                                    <td>{{ file.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Clients Causing Most Errors</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Client IP</th>
                                                    <th>Error Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for client in report_data.error_clients %}
                                                <tr>
                                                    <td>{{ client.cliente }}</td>
                                                    <td>{{ client.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                {% elif report_data.type == "ftp_events" %}
                    <!-- FTP Events Log Report -->
                    <h3 class="mt-4 mb-3">FTP Events Analysis</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>General Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total Events:</strong> {{ report_data.total_events }}</p>
                                    <p><strong>Login Statistics:</strong></p>
                                    <ul>
                                        <li>Successful Logins: {{ report_data.login_stats.successful_logins }}</li>
                                        <li>Failed Logins: {{ report_data.login_stats.failed_logins }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>FTP Actions Distribution</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.action_chart }}" class="img-fluid" alt="FTP Actions Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>FTP Events Over Time</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.events_by_day_chart }}" class="img-fluid" alt="Events By Day Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Most Active Users</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Events</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for user in report_data.active_users %}
                                                <tr>
                                                    <td>{{ user.usuario }}</td>
                                                    <td>{{ user.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Most Active IPs</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>IP Address</th>
                                                    <th>Events</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for ip in report_data.active_ips %}
                                                <tr>
                                                    <td>{{ ip.ip }}</td>
                                                    <td>{{ ip.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Most Accessed Files</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>File Path</th>
                                                    <th>Access Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for file in report_data.accessed_files %}
                                                <tr>
                                                    <td>{{ file.archivo }}</td>
                                                    <td>{{ file.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                {% elif report_data.type == "ftp_transfers" %}
                    <!-- FTP Transfers Log Report -->
                    <h3 class="mt-4 mb-3">FTP Transfers Analysis</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>General Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total Transfers:</strong> {{ report_data.total_transfers }}</p>
                                    <p><strong>Average Transfer Duration:</strong> {{ "%.2f"|format(report_data.avg_duration) }} seconds</p>
                                    <p><strong>Total Data Transferred:</strong></p>
                                    <ul>
                                        <li>Uploads: {{ (report_data.transfer_volume.total_upload_bytes / 1048576)|round(2) }} MB</li>
                                        <li>Downloads: {{ (report_data.transfer_volume.total_download_bytes / 1048576)|round(2) }} MB</li>
                                        <li>Total: {{ (report_data.transfer_volume.total_transfer_bytes / 1048576)|round(2) }} MB</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Transfer Direction</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.direction_chart }}" class="img-fluid" alt="Transfer Direction Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Transfer Size Distribution</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.size_chart }}" class="img-fluid" alt="Transfer Size Chart">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Transfers Over Time</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ report_data.transfers_by_day_chart }}" class="img-fluid" alt="Transfers By Day Chart">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Transfer Services</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Service</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for service in report_data.services %}
                                                <tr>
                                                    <td>{{ service.servicio }}</td>
                                                    <td>{{ service.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Authentication Methods</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Auth Method</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for method in report_data.auth_methods %}
                                                <tr>
                                                    <td>{{ method.metodo_autenticacion }}</td>
                                                    <td>{{ method.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Most Active Users</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Transfers</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for user in report_data.active_users %}
                                                <tr>
                                                    <td>{{ user.usuario }}</td>
                                                    <td>{{ user.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Most Active IPs</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>IP Address</th>
                                                    <th>Transfers</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for ip in report_data.active_ips %}
                                                <tr>
                                                    <td>{{ ip.ip_remota }}</td>
                                                    <td>{{ ip.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                {% else %}
                    <div class="alert alert-warning">
                        <h4>Report Not Available</h4>
                        <p>{{ report_data.message }}</p>
                    </div>
                {% endif %}
                
            {% else %}
                <div class="alert alert-warning">
                    <h4>No Data Available</h4>
                    <p>There is currently no data in any of the log tables. Please ensure logs are being imported correctly.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}